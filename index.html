<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>魔法營地 — 互動敘事地圖</title>
<style>
:root {
  --bg: #0f0f1a;
  --bg2: #161625;
  --bg3: #1e1e32;
  --text: #e8e8f0;
  --text2: #8888a0;
  --text3: #555570;
  --accent: #a855f7;
  --accent2: #533483;
  --accent-glow: #a855f722;
  --border: #2a2a42;
  --card: #1a1a2e;
  --card-hover: #1e1e36;
  --tag-bg: rgba(74,153,153,0.15);
  --tag-text: #5db8b8;
  --success: #4ade80;
  --radius: 10px;
  --bubble-npc: #1e2a3a;
  --bubble-mc: #2a1e3a;
  --bubble-narrator: #1a1a2e;
  --speaker-npc: #60a5fa;
  --speaker-mc: #c084fc;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, 'Noto Sans TC', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  height: 100vh;
  overflow: hidden;
}
.app { display: flex; height: 100vh; flex-direction: column; }

/* === Game Header Banner === */
.game-banner {
  background: linear-gradient(135deg, var(--accent2) 0%, var(--bg3) 50%, var(--bg2) 100%);
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}
.game-banner::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 300px; height: 100%;
  background: radial-gradient(ellipse at 80% 50%, var(--accent-glow), transparent 70%);
  pointer-events: none;
}
.game-banner h1 { font-size: 26px; font-weight: 700; color: #fff; letter-spacing: 1px; margin-bottom: 2px; }
.game-banner .subtitle { font-size: 13px; color: rgba(255,255,255,0.45); font-style: italic; margin-bottom: 8px; }
.game-banner .banner-stats { display: flex; gap: 16px; font-size: 12px; color: rgba(255,255,255,0.55); }
.game-banner .banner-stats .stat-item { display: flex; align-items: center; gap: 5px; }
.game-banner .banner-stats b { color: var(--accent); }
.translation-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;
}
.translation-badge.full { background: rgba(74,222,128,0.15); color: var(--success); }
.translation-badge.partial { background: rgba(251,191,36,0.15); color: #fbbf24; }

/* === Toolbar === */
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
}
.search-box {
  padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
  background: var(--bg); color: var(--text); font-size: 13px;
  width: 220px; flex-shrink: 1; min-width: 140px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.search-box::placeholder { color: var(--text3); }
.toolbar-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
.toggle-row { display: flex; align-items: center; gap: 5px; font-size: 12px; color: var(--text2); cursor: pointer; white-space: nowrap; user-select: none; }
.toggle-row input { accent-color: var(--accent); cursor: pointer; }
.toggle-row:hover { color: var(--text); }
.view-toggle { display: flex; gap: 4px; }
.view-btn {
  padding: 5px 14px; border-radius: 6px; border: 1px solid var(--border);
  background: transparent; color: var(--text2); font-size: 12px; cursor: pointer; transition: all 0.2s;
}
.view-btn:hover { background: var(--bg3); color: var(--text); }
.view-btn.active { background: var(--accent2); color: #fff; border-color: var(--accent2); box-shadow: 0 2px 8px rgba(83,52,131,0.3); }

/* === Content Area === */
.content { flex: 1; overflow-y: auto; padding: 16px 20px 40px; scroll-behavior: smooth; }

/* === Group Headers === */
.group-header {
  width: 100%;
  background: linear-gradient(135deg, var(--accent2), var(--bg3));
  padding: 14px 20px;
  margin: 20px 0 6px 0;
  border-radius: var(--radius);
  position: sticky; top: 0; z-index: 10;
  cursor: pointer; user-select: none;
  display: flex; align-items: center; gap: 12px;
  transition: transform 0.1s;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.group-header:first-child { margin-top: 0; }
.group-header:active { transform: scale(0.995); }
.group-arrow { font-size: 12px; color: rgba(255,255,255,0.4); transition: transform 0.2s; flex-shrink: 0; }
.group-arrow.open { transform: rotate(90deg); }
.group-info { flex: 1; min-width: 0; }
.group-header h2 { font-size: 18px; font-weight: 600; color: #fff; margin: 0; border: none; padding: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.group-header .group-name-en { font-size: 11px; color: rgba(255,255,255,0.35); font-style: italic; margin-top: 1px; }
.group-header .group-stats { font-size: 12px; color: rgba(255,255,255,0.45); flex-shrink: 0; }
.group-header .group-stats b { color: var(--accent); }
.group-body { display: none; padding: 2px 0; }
.group-body.open { display: block; }

/* === Dialogue Bubble UI === */
.msg {
  display: flex;
  gap: 10px;
  padding: 6px 12px;
  margin: 3px 0;
  align-items: flex-start;
  max-width: 85%;
  animation: fadeIn 0.15s ease;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

.msg.npc { flex-direction: row; margin-right: auto; }
.msg.mc { flex-direction: row-reverse; margin-left: auto; }
.msg.narrator { max-width: 70%; margin: 8px auto; justify-content: center; }

/* Portrait */
.msg-portrait {
  width: 52px; height: 52px;
  border-radius: 50%;
  flex-shrink: 0;
  border: 2px solid var(--border);
  background: var(--bg3);
  object-fit: cover;
  image-rendering: pixelated;
}
.msg.mc .msg-portrait { border-color: var(--speaker-mc); }
.msg.npc .msg-portrait { border-color: var(--speaker-npc); }

/* Bubble */
.msg-bubble {
  background: var(--bubble-npc);
  border-radius: 14px;
  padding: 8px 14px;
  position: relative;
  min-width: 60px;
  border: 1px solid rgba(255,255,255,0.06);
}
.msg.mc .msg-bubble { background: var(--bubble-mc); }
.msg.narrator .msg-bubble {
  background: var(--bubble-narrator);
  border: 1px dashed var(--border);
  font-style: italic;
  text-align: center;
}

/* Speaker Name */
.msg-speaker {
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 2px;
  letter-spacing: 0.3px;
}
.msg.npc .msg-speaker { color: var(--speaker-npc); }
.msg.mc .msg-speaker { color: var(--speaker-mc); }

/* Message Text */
.msg-text {
  font-size: 14.5px;
  line-height: 1.75;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
}
.msg-text-en {
  font-size: 11.5px;
  color: var(--text2);
  margin-top: 4px;
  padding-top: 4px;
  border-top: 1px dashed rgba(255,255,255,0.08);
  font-style: italic;
  line-height: 1.5;
  white-space: pre-wrap;
}

/* CG Image */
.msg-cg {
  margin: 8px 0;
  text-align: center;
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
}
.msg-cg img {
  max-width: 100%;
  max-height: 300px;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  border: 1px solid var(--border);
}
.msg-cg img:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.msg-cg-label {
  font-size: 10px;
  color: var(--text3);
  margin-top: 4px;
}

/* Choice */
.msg-choice {
  margin: 6px 12px;
  padding: 8px 14px;
  background: var(--bg3);
  border-radius: 10px;
  border: 1px solid var(--border);
  max-width: 85%;
}
.msg-choice-label {
  font-size: 11px;
  color: var(--text3);
  margin-bottom: 4px;
}
.msg-choice-item {
  display: inline-block;
  padding: 3px 12px;
  margin: 2px 4px 2px 0;
  border-radius: 16px;
  background: rgba(96,165,250,0.12);
  color: var(--speaker-npc);
  font-size: 13px;
  border: 1px solid rgba(96,165,250,0.2);
}

/* PID overlay */
.msg-pid {
  font-size: 9px;
  color: var(--text3);
  font-family: 'Consolas', monospace;
  position: absolute;
  top: 4px;
  right: 8px;
  opacity: 0;
  transition: opacity 0.15s;
}
.msg:hover .msg-pid,
.msg-cg:hover .msg-pid { opacity: 1; }

/* === CG Lightbox === */
.lightbox {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.92);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}
.lightbox.active { display: flex; }
.lightbox img {
  max-width: 95vw;
  max-height: 95vh;
  border-radius: 8px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
}

/* === Loading / Empty === */
.loading { text-align: center; padding: 80px 20px; color: var(--text2); }
.loading .spinner {
  display: inline-block; width: 36px; height: 36px;
  border: 3px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 14px; }

/* === Scrollbar === */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent2); }

/* === Mobile === */
@media (max-width: 768px) {
  .game-banner { padding: 16px; }
  .game-banner h1 { font-size: 22px; }
  .content { padding: 10px 8px 40px; }
  .msg { max-width: 95%; padding: 4px 6px; }
  .msg.narrator { max-width: 90%; }
  .msg-portrait { width: 40px; height: 40px; }
  .msg-text { font-size: 14px; }
  .toolbar { padding: 6px 10px; gap: 6px; }
  .search-box { width: 100%; }
  .toolbar-right { margin-left: 0; width: 100%; flex-wrap: wrap; justify-content: center; }
  .view-toggle { width: 100%; justify-content: center; }
  .group-header { padding: 12px 14px; }
  .group-header h2 { font-size: 16px; }
  .msg-cg img { max-height: 200px; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Game Banner -->
  <div class="game-banner">
    <h1 id="gameTitle">載入中...</h1>
    <div class="subtitle" id="gameSubtitle"></div>
    <div class="banner-stats" id="bannerStats"></div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <input type="text" class="search-box" id="searchBox" placeholder="搜尋對話內容或角色名...">
    <div class="toolbar-right">
      <label class="toggle-row">
        <input type="checkbox" id="showZh" checked>
        <span>中文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showEn">
        <span>英文原文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showName">
        <span>段落 ID</span>
      </label>
      <div class="view-toggle">
        <button class="view-btn active" data-view="group" id="viewGroup">按場景</button>
        <button class="view-btn" data-view="all" id="viewAll">全部對話</button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <div class="loading">
      <div class="spinner"></div>
      <div>載入敘事數據中...</div>
    </div>
  </div>
</div>

<!-- CG Lightbox -->
<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="" alt="">
</div>

<script>
// === Config (injected by build script) ===
const GAME_CONFIG = {"title": "Magical Camp", "title_zh": "魔法營地", "color_accent": "#a855f7", "engine": "rpgmaker"};

// Protagonist detection: names and face patterns that indicate MC
const MC_NAMES = new Set(['erica', 'eric', '\\v[1]', 'you', '你']);
const MC_FACE_PATTERNS = ['MC2', 'MC3', 'mc2', 'mc3'];

function isMC(p) {
  const name = (p.speaker_name || '').toLowerCase();
  if (MC_NAMES.has(name)) return true;
  const face = p.portrait || '';
  return MC_FACE_PATTERNS.some(pat => face.includes(pat));
}

// === State ===
let DATA = null;
let searchQuery = '';
let showZh = true;
let showEn = false;
let showName = false;
let currentView = 'group';
let openGroups = new Set();

// === Data Loading ===
async function loadData() {
  const resp = await fetch('data/passages.json?v=' + Date.now());
  DATA = await resp.json();
  if (!DATA.meta.has_zh) {
    document.getElementById('showZh').parentElement.style.display = 'none';
    showZh = false;
    showEn = true;
    document.getElementById('showEn').checked = true;
  }
  init();
}

// === Banner ===
function renderBanner() {
  const m = DATA.meta;
  const titleZh = m.title_zh || m.title || '';
  const titleEn = m.title || '';
  document.getElementById('gameTitle').textContent = titleZh;
  document.getElementById('gameSubtitle').textContent = titleZh !== titleEn ? titleEn : '';
  document.title = titleZh + ' — 互動敘事地圖';

  const total = m.total || DATA.passages.length;
  const dialogues = DATA.passages.filter(p => p.type !== 'picture' && p.type !== 'choice').length;
  const zhCount = DATA.passages.filter(p => p.content_zh).length;
  const groupCount = (DATA.groups || []).length;
  const pct = dialogues > 0 ? Math.round(zhCount / dialogues * 100) : 0;

  let badgeClass = pct >= 95 ? 'full' : 'partial';
  let badgeText = pct >= 95 ? '\u2713 翻譯完成' : `${pct}% 已翻譯`;

  document.getElementById('bannerStats').innerHTML = `
    <span class="stat-item"><b>${groupCount}</b> 場景</span>
    <span class="stat-item"><b>${dialogues}</b> 對話</span>
    <span class="translation-badge ${badgeClass}">${badgeText}</span>
  `;
}

// === Filtering ===
function getFiltered() {
  let passages = DATA.passages;
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    passages = passages.filter(p =>
      (p.content_zh || '').toLowerCase().includes(q) ||
      (p.content || '').toLowerCase().includes(q) ||
      (p.speaker_name || '').toLowerCase().includes(q) ||
      (p.group || '').toLowerCase().includes(q)
    );
  }
  return passages;
}

// === Passage HTML (Dialogue Bubble) ===
function passageHtml(p) {
  const type = p.type || 'dialogue';

  // CG Image
  if (type === 'picture') {
    const cgName = p.cg_name || '';
    const src = `images/cgs/${cgName}.webp`;
    return `<div class="msg-cg" style="position:relative">
      <img src="${src}" loading="lazy" alt="${escHtml(cgName)}"
           onerror="this.parentElement.style.display='none'"
           onclick="openLightbox('${src}')">
      ${showName ? `<div class="msg-pid">#${p.pid}</div>` : ''}
    </div>`;
  }

  // Choice
  if (type === 'choice') {
    const choices = p.choices || p.content.split('\n');
    const items = (Array.isArray(choices) ? choices : [choices])
      .map(c => `<span class="msg-choice-item">${escHtml(String(c))}</span>`).join('');
    return `<div class="msg-choice">
      <div class="msg-choice-label">&#9654; 選項</div>
      ${items}
    </div>`;
  }

  // Dialogue
  const speaker = p.speaker_name || '';
  const mc = isMC(p);
  const hasPortrait = !!p.portrait;
  const align = speaker ? (mc ? 'mc' : 'npc') : 'narrator';

  const portraitHtml = hasPortrait
    ? `<img class="msg-portrait" src="${p.portrait}" alt="${escHtml(speaker)}" loading="lazy" onerror="this.style.display='none'">`
    : (speaker ? `<div class="msg-portrait" style="display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--text3)">${speaker.charAt(0)}</div>` : '');

  const speakerHtml = speaker ? `<div class="msg-speaker">${escHtml(speaker)}</div>` : '';

  let textHtml = '';
  if (showZh && p.content_zh) {
    textHtml += `<div class="msg-text">${formatText(p.content_zh)}</div>`;
    if (showEn && p.content) {
      textHtml += `<div class="msg-text-en">${formatText(p.content)}</div>`;
    }
  } else if (p.content) {
    textHtml += `<div class="msg-text">${formatText(p.content)}</div>`;
  } else if (p.content_zh) {
    textHtml += `<div class="msg-text">${formatText(p.content_zh)}</div>`;
  }

  const pidHtml = showName ? `<span class="msg-pid">#${p.pid}</span>` : '';

  return `<div class="msg ${align}">
    ${portraitHtml}
    <div class="msg-bubble">
      ${speakerHtml}${textHtml}${pidHtml}
    </div>
  </div>`;
}

function formatText(s) {
  if (!s) return '';
  let html = escHtml(s);
  // Convert ![cg](url) to inline image
  html = html.replace(/!\[cg\]\(([^)]+)\)/g, '<img src="$1" style="max-width:100%;border-radius:8px;cursor:pointer" loading="lazy" onclick="openLightbox(\'$1\')" alt="">');
  html = html.replace(/\n/g, '<br>');
  return html;
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// === Lightbox ===
function openLightbox(src) {
  const lb = document.getElementById('lightbox');
  document.getElementById('lightboxImg').src = src;
  lb.classList.add('active');
}
document.getElementById('lightbox').addEventListener('click', function() {
  this.classList.remove('active');
  document.getElementById('lightboxImg').src = '';
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('lightbox').classList.remove('active');
    document.getElementById('lightboxImg').src = '';
  }
});

// === Group View ===
function renderGroupView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  const groups = groupPassages(passages);

  if (groups.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }

  groups.forEach(([gName, gPassages]) => {
    const isOpen = openGroups.has(gName);
    const gInfo = (DATA.groups || []).find(g => g.id === gName);
    const displayName = gInfo ? (gInfo.name_zh || gInfo.name || gName) : gName;
    const displayNameEn = gInfo && gInfo.name_zh && gInfo.name !== gInfo.name_zh ? gInfo.name : '';
    const dialogueCount = gPassages.filter(p => (p.type || 'dialogue') === 'dialogue').length;

    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `
      <span class="group-arrow${isOpen ? ' open' : ''}">&#9654;</span>
      <div class="group-info">
        <h2>${escHtml(displayName)}</h2>
        ${displayNameEn ? `<div class="group-name-en">${escHtml(displayNameEn)}</div>` : ''}
      </div>
      <div class="group-stats"><b>${dialogueCount}</b> 對話</div>
    `;

    const body = document.createElement('div');
    body.className = 'group-body' + (isOpen ? ' open' : '');

    header.addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      header.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openGroups.add(gName);
        if (!body.dataset.rendered) {
          renderPassageChunked(body, gPassages, 0);
          body.dataset.rendered = '1';
        }
      } else {
        openGroups.delete(gName);
      }
    });

    if (isOpen && !body.dataset.rendered) {
      renderPassageChunked(body, gPassages, 0);
      body.dataset.rendered = '1';
    }

    content.appendChild(header);
    content.appendChild(body);
  });
}

function groupPassages(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const g = p.group || '(未分類)';
    if (!groups.has(g)) groups.set(g, []);
    groups.get(g).push(p);
  });
  if (DATA.groups && DATA.groups.length > 0) {
    const ordered = [];
    const seen = new Set();
    DATA.groups.forEach(gi => {
      const key = gi.id || gi.name;
      if (groups.has(key)) {
        ordered.push([key, groups.get(key)]);
        seen.add(key);
      }
    });
    groups.forEach((v, k) => { if (!seen.has(k)) ordered.push([k, v]); });
    return ordered;
  }
  return Array.from(groups.entries()).sort((a, b) => b[1].length - a[1].length);
}

// === All View ===
function renderAllView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  if (passages.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }
  renderPassageChunked(content, passages, 0);
}

// === Chunked Rendering ===
function renderPassageChunked(container, passages, startIdx) {
  const CHUNK = 100;
  const end = Math.min(startIdx + CHUNK, passages.length);
  let html = '';
  for (let i = startIdx; i < end; i++) {
    html += passageHtml(passages[i]);
  }
  container.insertAdjacentHTML('beforeend', html);

  if (end < passages.length) {
    const sentinel = document.createElement('div');
    sentinel.className = 'loading';
    sentinel.style.padding = '20px';
    sentinel.innerHTML = `<div style="font-size:12px;color:var(--text3)">載入更多 (${end}/${passages.length})...</div>`;
    container.appendChild(sentinel);

    const obs = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        obs.disconnect();
        sentinel.remove();
        renderPassageChunked(container, passages, end);
      }
    });
    obs.observe(sentinel);
  }
}

// === Render ===
function resetAndRender() {
  const passages = getFiltered();
  if (currentView === 'group') {
    renderGroupView(passages);
  } else {
    renderAllView(passages);
  }
}

function setActiveView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(view === 'group' ? 'viewGroup' : 'viewAll').classList.add('active');
  resetAndRender();
}

// === Init ===
function init() {
  renderBanner();

  let searchTimeout;
  document.getElementById('searchBox').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      resetAndRender();
    }, 300);
  });

  document.getElementById('showZh').addEventListener('change', (e) => {
    showZh = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showEn').addEventListener('change', (e) => {
    showEn = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showName').addEventListener('change', (e) => {
    showName = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });

  document.getElementById('viewGroup').addEventListener('click', () => setActiveView('group'));
  document.getElementById('viewAll').addEventListener('click', () => setActiveView('all'));

  resetAndRender();
}

function clearRenderedCache() {
  openGroups.clear();
  document.querySelectorAll('.group-body').forEach(div => {
    div.dataset.rendered = '';
  });
}

loadData();
</script>
</body>
</html>
